---
description: Remind to update docs when implementation changes affect documented behavior
globs: "**/*.go,**/*.proto"
alwaysApply: false
---

# Doc drift prevention

When a change touches any of the following, check whether the corresponding doc needs updating. If it does, update it in the same changeset — don't leave it for later.

## What triggers a doc update

| Change | Docs to check |
|--------|--------------|
| Add/remove/rename a transaction type | `docs/architecture.md` (Transaction Types section), `PROTOCOL.md` (transaction table) |
| Change a protobuf message shape | `PROTOCOL.md` (if client-facing), `docs/architecture.md` (if it affects a flow) |
| Add/remove/rename a PebbleDB key space or field | `docs/storage.md` |
| Change the content file layout or directory structure | `docs/content.md`, `PROTOCOL.md` (content files section) |
| Change fee calculation, token economics, or payment flow | `docs/economics.md`, `PROTOCOL.md` (token / purchase section) |
| Change access policy types or Casbin model | `docs/architecture.md` (Policy Plane), `PROTOCOL.md` (access policy types) |
| Change the API surface (GraphQL schema, ConnectRPC service) | `PROTOCOL.md` (API section), `docs/architecture.md` (API Layer) |
| Change validator election, takedown, or oracle logic | `docs/governance.md` |
| Change crypto (key types, wrapping, derivation) | `docs/architecture.md` (Keys section), `PROTOCOL.md` (auth / device encryption) |
| Change BitTorrent integration or reconciliation | `docs/content.md` |
| Add/remove a Goja built-in or sandbox constraint | `docs/architecture.md` (Policy Plane — Programmable policies) |

## What does NOT need a doc update

- Internal refactors that don't change behavior (renaming a Go function, moving code between files)
- Test changes
- Dependency bumps
- Build/CI changes

## How to update

- Keep the same voice and structure as the existing doc
- Update mermaid diagrams in `docs/diagrams/` if a flow changes
- If adding a new concept, add it to `docs/README.md` open questions if the design isn't settled
- If changing client-facing behavior, update `PROTOCOL.md` — this is what external repos copy
