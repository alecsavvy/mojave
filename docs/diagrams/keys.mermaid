graph TD
    subgraph Identity["Identity Layer"]
        ED[Ed25519 Keypair<br/>signing — transactions,<br/>entitlements, access requests]
    end

    subgraph DeviceKeys["Device Encryption Keys"]
        DK1[Device 1<br/>X25519 keypair<br/>local keychain]
        DK2[Device 2<br/>X25519 keypair<br/>local keychain]
        DK3[Device N<br/>X25519 keypair<br/>local keychain]
    end

    subgraph Recovery["Uploader Recovery Key"]
        SC{Self-custody?}
        SC -->|yes| BMAP[Ed25519 → X25519<br/>birational map<br/>filippo.io/edwards25519]
        SC -->|custodial wallet| SIGN["sign('mojave:recovery-key:v1')<br/>hash signature → X25519"]
        BMAP --> RK[Recovery X25519 Key<br/>stable, deterministic]
        SIGN --> RK
    end

    subgraph Wrapping["DEK Wrapping"]
        EPH[Generate ephemeral<br/>X25519 keypair]
        ECDH[ECDH:<br/>ephemeral private ×<br/>recipient public]
        SYM[Derive symmetric<br/>wrapping key]
        WRAP[Encrypt DEK<br/>with wrapping key]
        OUT[Wrapped DEK<br/>+ ephemeral public key]

        EPH --> ECDH
        ECDH --> SYM
        SYM --> WRAP
        WRAP --> OUT
    end

    ED -->|signs access requests| DK1
    ED -->|signs access requests| DK2
    ED -->|signs access requests| DK3
    DK1 -->|pubkey in request| ECDH
    DK2 -->|pubkey in request| ECDH
    DK3 -->|pubkey in request| ECDH
    RK -->|uploader on-chain DEK| ECDH

    style ED fill:#1a5276,color:#fff
    style RK fill:#922b21,color:#fff
    style DK1 fill:#2d6a4f,color:#fff
    style DK2 fill:#2d6a4f,color:#fff
    style DK3 fill:#2d6a4f,color:#fff
