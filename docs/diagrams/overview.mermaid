graph TB
    subgraph Clients
        CL[Client / Rights Holder<br/>Ed25519 keypair]
        CO[Consumer<br/>Ed25519 keypair]
        DT[Desktop — Tauri + Rust]
        BR[Browser — OPFS]
    end

    subgraph PolicyPlane["Policy Plane"]
        CB[Casbin<br/>RBAC / ABAC / ACL]
        GJ[Goja JS Runtime<br/>Programmable policies<br/>+ Proof scripts]
    end

    subgraph ConsensusPlane["Consensus Plane"]
        CMT[CometBFT<br/>ABCI State Machine]
        ST[On-Chain State<br/>Uploads, Releases,<br/>Entitlements, Policies,<br/>Uploader Wrapped DEKs]
        EV[ABCI Events<br/>upload.complete<br/>release.published]
    end

    subgraph EncryptionPlane["Encryption Plane"]
        TDF[OpenTDF<br/>.tdf encrypted blobs]
        DEK[DEK / KEK Wrapping<br/>X25519 ECDH]
    end

    subgraph StoragePlane["Storage Plane"]
        BT[BitTorrent<br/>File replication<br/>CID rendezvous]
        GC[gocloud.dev<br/>Local validator storage]
    end

    subgraph Validators
        V1[Validator 1<br/>CometBFT node]
        V2[Validator 2<br/>CometBFT node]
        V3[Validator N<br/>CometBFT node]
    end

    CL -->|upload + PublishRelease| CMT
    CO -->|access request<br/>signed + device X25519 pubkey| V1
    V1 --> CB
    V1 --> GJ
    CB --> ST
    GJ --> ST
    CMT --> ST
    CMT --> EV
    EV -->|triggers replication| BT
    V1 --> TDF
    V1 --> DEK
    TDF --> BT
    BT --> GC
    V1 ---|CometBFT reactors<br/>wrapped DEK distribution| V2
    V2 ---|CometBFT reactors| V3
    DT -->|BitTorrent| BT
    BR -->|HTTP / ConnectRPC| V1
    DT -->|ConnectRPC / GraphQL| V1

    style ConsensusPlane fill:#1a1a2e,color:#fff
    style StoragePlane fill:#16213e,color:#fff
    style EncryptionPlane fill:#0f3460,color:#fff
    style PolicyPlane fill:#533483,color:#fff
